function addTxtCon(){var type=document.querySelector('span[name="add_con_tab_group"]');var formData=new FormData();var mainInfo=document.querySelector('.con_main_info_edit.add_con');if(type.classList.contains('text')){var allContent=[];var parent=document.querySelector('.add_text_layout');var allContent=uniTxtCheck('export');formData.append('type','text');var button=document.querySelector('button[name="submit_add_txt_con"]');}else{allContent=mainInfo.querySelector('textarea.url').value;formData.append('type','link');var button=document.querySelector('button[name="submit_add_con"]');}
title=mainInfo.querySelector('textarea.title').value;if(title.length==0){sendAlert(`Looks like you left the title blank`,`I'll fix that`,'yep');return;}else if(allContent.length==0){sendAlert(`Looks like you left the connection blank`,`I'll fix that`,'yep');return;}
button.classList.add('prog');finalProgress=button.querySelector('svg');prog(finalProgress,100);formData.append('content',allContent);formData.append('title',title);formData.append('rrrr',rrrr);$.ajax({type:"POST",url:"includes/addtxtcon.inc.php",data:formData,contentType:false,processData:false,success:function(result){if(result=='success'){prog(finalProgress,101);resetCons();setTimeout(function(){closeAddCon('success');button.parentElement.classList.add('inactive');},500)}else{errorAlerts(result);if(result=='error=toomanycons'){closeAddCon('failed');}
button.classList.remove('prog');}}});}
function addTxtTabCheck(){var container=document.querySelector('scroll.add_connect');if(container.offsetHeight>=container.scrollHeight)container.querySelector('.action_bar').classList.add('active');}
function editTxtCon(){var parent=document.querySelector('scroll.edit_connect');var allContent=uniTxtCheck('export');if(!allContent)return;var id=parent.querySelector('.rounded_panel.con_main_info').getAttribute('data-id');var button=document.querySelector('button[name="submit_edit_text_con"]');var final=button.querySelector('svg');button.classList.add('prog');prog(final,100);var formData=new FormData;formData.append('content',allContent);formData.append('id',id);formData.append('rrrr',rrrr);if(ajaxRun){ajaxRun.abort();}
$.ajax({type:"POST",url:"includes/edittxtcon.inc.php",data:formData,contentType:false,processData:false,success:function(result){if(result=='success'){localTextEditBackup();prog(final,101);resetCons();var actionBar=document.querySelector('.edit_connect .action_bar');setTimeout(function(){actionBar.classList.remove('ready');setTimeout(function(){button.classList.remove('prog');},200)},500)}else{errorAlerts(result);}}})}
function addTxtEl(){var el=event.currentTarget.getAttribute('data-type');var elContainer=event.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.querySelector('.add_text_layout');var sect=document.createElement('div');var allEls=elContainer.querySelectorAll('.sect');if(uniTxtCheck('length')=='error=limit')return;if(el=='title'){sect.classList.add('sect','title','active');sect.setAttribute('data-type','title');sect.innerHTML='<textarea maxlength="70" placeholder="New heading"></textarea><div class="reorder bottom"></div><div class="reorder top"></div>';var finalSect=elContainer.querySelector('.sect.final');elContainer.insertBefore(sect,finalSect);autosize(document.querySelectorAll('textarea'));}else if(el=='body'){sect.classList.add('sect','body','active');sect.setAttribute('data-type','body');sect.innerHTML='<textarea maxlength="5000" placeholder="New text" onkeydown="delTxtEl(event)" onblur="deactEl(event)"></textarea><div class="reorder bottom"></div><div class="reorder top"></div>';var finalSect=elContainer.querySelector('.sect.final');elContainer.insertBefore(sect,finalSect);autosize(document.querySelectorAll('textarea'));}else if(el=='image'){sect.classList.add('sect','image');sect.setAttribute('data-type','image');sect.innerHTML='<div class="image_input_placeholder"><h3><div class="dvcn-image"></div><span></span></h3></div><input type="file" accept=".jpeg,.jpg,.png,.gif"><div class="reorder bottom"></div><div class="reorder top"></div>';var finalSect=elContainer.querySelector('.sect.final');elContainer.insertBefore(sect,finalSect);autosize(document.querySelectorAll('textarea'));}else if(el=='link'){sect.classList.add('sect','link','active');sect.setAttribute('data-type','link');sect.innerHTML='<textarea maxlength="2000" class="url" placeholder="URL" onkeydown="delTxtEl(event)" onblur="deactEl(event)"></textarea><textarea maxlength="70" class="title" placeholder="Link title" onkeydown="delTxtEl(event)" onblur="deactEl(event)"></textarea><div class="reorder bottom"></div><div class="reorder top"></div>';var finalSect=elContainer.querySelector('.sect.final');elContainer.insertBefore(sect,finalSect);autosize(document.querySelectorAll('textarea'));}
if(el!='image'){sect.querySelector('textarea').focus();}
var textPlace=elContainer.querySelector('.placeholder_text');if(textPlace)textPlace.remove();sectOn(sect);addSectMenu();uniTxtCheck();}
function uniTxtCheck(condition){var parent=document.querySelector('.add_text_layout');var allEls=parent.querySelectorAll('.sect');var allElsLength=allEls.length;if(condition=='length')allElsLength=allElsLength+1;if(allElsLength>21){sendAlert(`Text connections can only support 20 items right now. Sorry about that! You can blame our servers`,'Dang it!','mad');return 'error=limit';}
if(condition=='length')return;var sectsLeft=document.querySelector('.sects_left h3 span');sectsLeft.textContent=21-allEls.length;var allContent=[];for(i=0;i<allEls.length;i++){if(i>21){sendAlert('Text connections can only support 20 items right now. Sorry about that! You can blame our servers','Dang it!','mad');return;}
var sect=allEls[i];var type=sect.getAttribute('data-type');if(type=='image'){if(sect.hasAttribute('data-id')&&!sect.classList.contains('uploading')){var ratio=sect.getAttribute('data-ratio');var id=sect.getAttribute('data-id');allContent.push([type,id,ratio]);}else if(condition=='export'){sendAlert('Looks like you left an image blank. Either delete it or select an image to continue','I&apos;ll do that','yep');return;}else{allContent.push([type,'','']);}}else if(type=='title'||type=='body'){var content=sect.querySelector('textarea').value;if(content){allContent.push([type,content]);}else if(condition=='export'){sendAlert('Looks like you left a text element blank. Either delete it fill it to continue','I&apos;ll do that','yep');return;}else{allContent.push([type,content]);}}else if(type=='link'){var url=sect.querySelector('textarea.url').value;var title=sect.querySelector('textarea.title').value;var ready=1;if(!url){ready=0;}if(!title){ready=0;}
if(ready!=0){allContent.push([type,url,title]);}else if(condition=='export'){sendAlert('Looks like you left a link blank. Either delete it fill it to continue','I&apos;ll do that','yep');return;}else{allContent.push([type,url,title]);}}}
allContent=JSON.stringify(allContent);var actionBar=document.querySelector('.text_editor .action_bar');if(condition=='export'){return allContent;}else if(txtBackup!=allContent){actionBar.classList.add('ready');}else{actionBar.classList.remove('ready');}}
function reorderTxtEl(el,np,npo){var type=el.getAttribute('data-type');var sect=document.createElement('div');if(type=='body'){sect.classList.add('sect','body');sect.setAttribute('data-type','body');var value=encode(el.querySelector('textarea').value);sect.innerHTML=`<textarea maxlength="1000" placeholder="New text">${value}</textarea><div class="reorder bottom"></div><div class="reorder top"></div>`;}else if(type=='title'){sect.classList.add('sect','title');sect.setAttribute('data-type','title');var value=encode(el.querySelector('textarea').value);sect.innerHTML=`<textarea maxlength="70" placeholder="New heading">${value}</textarea><div class="reorder bottom"></div><div class="reorder top"></div>`;}else if(type=='image'){var image=el.innerHTML;if(el.classList.contains('file_here')){var ogCanvas=el.querySelector('canvas');}
sect.classList.add('sect','image');sect.setAttribute('data-type','image');sect.innerHTML=image;if(el.classList.contains('file_here')){sect.classList.add('file_here');var ncContext=sect.querySelector('canvas').getContext('2d');ncContext.drawImage(ogCanvas,0,0);sect.setAttribute('data-id',el.getAttribute('data-id'));sect.setAttribute('data-ratio',el.getAttribute('data-ratio'));if(el.classList.contains('pre_existing')){sect.classList.add('pre_existing');}}}else if(type=='link'){var title=el.querySelector('textarea.title').value;var url=el.querySelector('textarea.url').value;sect.classList.add('sect','link');sect.setAttribute('data-type','link');sect.innerHTML=`<textarea maxlength="2000" placeholder="URL" class="url">${url}</textarea><textarea maxlength="70" placeholder="Link title" class="title">${title}</textarea><div class="reorder bottom"></div><div class="reorder top"></div>`;autosize(document.querySelectorAll('textarea'));}
var parent=np.parentElement;if(npo=='afterend'){parent.insertBefore(sect,np.nextSibling);}else{parent.insertBefore(sect,np);}
sectOn(sect);autosize(document.querySelectorAll('textarea'));setTimeout(function(){uniTxtCheck();},1)}
function deactEl(event){var ct=event.currentTarget;if(ct.parentElement.classList.contains('link')){var links=ct.parentElement.querySelectorAll('textarea');var needActive=0;for(i=0;i<links.length;i++){if(links[i]===event.relatedTarget){needActive=1;}}
if(needActive==0){ct.parentElement.classList.remove('active');}}else{ct.parentElement.classList.remove('active');}
uniTxtCheck();}
function showURLPrevImg(event){var ct=event.currentTarget;var url=ct.value;var oldImg=ct.parentElement.querySelector('img');if(ct.parentElement.contains(oldImg)){oldImg.remove();}
ct.insertAdjacentHTML('afterend',`<img src="${url}" class='image_url_view'>`);}
function delTxtEl(event){var ct=event.currentTarget;var key=event.keyCode||event.charCode;if(key==8&&ct.value==''||key==46&&ct.value==''){if(!ct.parentElement.previousSibling.classList.contains('placeholder')){ct.parentElement.previousSibling.querySelector('textarea').focus();}
ct.parentElement.remove();}else{ct.style.height='';var height=ct.scrollHeight;ct.style.height=`${height}px`;}}
function openAddCon(){var container=document.querySelector('.featured_action');container.parentElement.classList.add('prep_fa');var expander=document.querySelector('section.right .expander');var expanderContent=expander.querySelector('scroll');expanderContent.classList.remove('edit_connect');expanderContent.classList.add('add_connect');expanderContent.addEventListener('scroll',checkLayoutPos,false);var button=document.querySelector('button[name="open_add_con"]');expanderContent.innerHTML='';var loader=expander.querySelector('.expander_loader');loader.classList.add('loading');expander.classList.add('featured');expander.style.height=`calc(100% + 6px)`;expander.style.top=`calc(100% + 6px)`;expander.style.left=`0px`;expander.style.width=`100%`;expander.querySelector('h3.leg_title').innerHTML=button.querySelector('h3').innerHTML;expander.querySelector('.exp_header h3').textContent='New connection';setTimeout(function(){expander.classList.add('active');expander.style.top=`0`;},20)
var formData=new FormData();formData.append('rrrr',rrrr);if(ajaxRun){ajaxRun.abort();}
$.ajax({type:"POST",url:"includes/pan/addtxtcon.pan.php",data:formData,contentType:false,processData:false,success:function(result){if(result.includes('error=')&&result.length<50){errorAlerts(result);closeAddCon('failed');}else{expanderContent.innerHTML=result;expander.classList.add('content_ready');loader.classList.remove('loading');addConOn();container.parentElement.classList.add('prep_fa');setTimeout(function(){checkTooltips();autosize(document.querySelectorAll('textarea'));},300)}}})}
function closeAddCon(status){var container=document.querySelector('scroll.add_connect');if(status!=='success'&&status!=='failed'){var allImgs=container.querySelector('.add_text_layout').querySelectorAll('.sect.image.file_here');var ids=[];for(i=0;i<allImgs.length;i++){var id=allImgs[i].getAttribute('data-id');ids.push(id);}
if(ids.length!=0){deleteTxtImages(ids);}}
document.querySelector('scroll.edit_connects').classList.remove('prep_fa');var expander=document.querySelector('section.right .expander');expander.style.top='calc(100% + 6px)';var actionBar=expander.querySelector('.action_bar');if(actionBar)actionBar.classList.remove('active');setTimeout(function(){expander.classList.remove('active','content_ready','featured');},500)}
function imageDrop(event){var ct=event.currentTarget;var file=ct.files[0];var fileSize=file.size;if(fileSize<16000000){var fileName=file.name;var ext=fileName.substr(fileName.lastIndexOf('.')+1).toLowerCase();if(ext=='gif'||ext=='png'||ext=='jpeg'||ext=='jpg'){var img=document.createElement('img');var container=ct.parentElement;var reader=new FileReader();reader.onload=function(e){img.setAttribute('src',e.target.result);img.onload=function(){var ratio=this.height/this.width;var height=700*ratio;var canvas=document.createElement('canvas');canvas.width=700;canvas.height=height;var context=canvas.getContext("2d");context.scale(700/this.width,height/this.height);context.drawImage(this,0,0);container.appendChild(canvas);}};reader.readAsDataURL(file);container.classList.add('file_here','uploading');var placeholder=container.querySelector('.image_input_placeholder span');var formData=new FormData();formData.append('file',file);formData.append('rrrr',rrrr);$.ajax({xhr:function(){var xhr=new window.XMLHttpRequest();xhr.upload.addEventListener("progress",function(evt){if(evt.lengthComputable){var percentComplete=evt.loaded/evt.total;percentComplete=parseInt(percentComplete*100);if(percentComplete===100)placeholder.innerHTML='Processing';else placeholder.innerHTML=`${percentComplete}% uploaded`;}},false);return xhr;},url:'includes/uploadtxtimg.inc.php',type:"POST",data:formData,contentType:false,processData:false,success:function(result){if(result.includes('error=')&&result.length<50){errorAlerts(result);placeholder.innerHTML='';container.classList.remove('file_here','uploading');container.querySelector('canvas').remove();}else{result=JSON.parse(result);container.setAttribute('data-id',result['id']);container.setAttribute('data-ratio',result['ratio']);container.classList.remove('uploading');}}})}else{errorAlerts('error=invalidtype');}}else{errorAlerts('error=largefile');}}
function deleteTxtImages(imgs){var imgs=JSON.stringify(imgs);var formData=new FormData;formData.append('imgs',imgs);formData.append('rrrr',rrrr);$.ajax({type:"POST",url:"includes/deletetxtimg.inc.php",data:formData,contentType:false,processData:false,success:function(result){}})}
function resizeBase64Img(base64,width,height){var canvas=document.createElement("canvas");canvas.width=width;canvas.height=height;var context=canvas.getContext("2d");var deferred=$.Deferred();$("<img/>").attr("src",base64).load(function(){context.scale(width/this.width,height/this.height);context.drawImage(this,0,0);deferred.resolve($("<img/>").attr("src",canvas.toDataURL()));});return deferred.promise();}
function migrateAddEmail(){var input=document.querySelector('textarea[name="add_con_url"]');var inputVal=input.value;document.querySelector('button[name="add_text_tab"]').click();document.querySelector('.action_bar .adds_container button[data-type="body"]').click();addSectMenu();document.activeElement.value=inputVal;input.value='';}
function isLinkReady(event){var ct=event.currentTarget;var url=ct.value;var output=document.querySelector('.link_platform_info .main_info');var emailCheck=document.querySelector('[name="add_con_tab_group"] span.text[data-email-check="true"]')
if(url.includes('@')&&!url.includes('/')&&!emailCheck){sendAlert(`It looks like you're trying to add an email or username in the link area. If we're right, you will need to add it as a page connection instead. If you want, you can click "Switch" and we'll swap it for you!`,'Switch','replace',migrateAddEmail);document.querySelector('[name="add_con_tab_group"] span.text').setAttribute('data-email-check','true');}
if(isValidHttpUrl(url)){if(ajaxRun){ajaxRun.abort();}
var formData=new FormData();formData.append('url',url.toLowerCase());ajaxRun=$.ajax({type:"POST",url:"includes/platformrec.inc.php",data:formData,contentType:false,processData:false,success:function(result){result=JSON.parse(result);output.style.color='';if(result[0]=='error=noturl'){var message='<div class="dvcn-link"></div>Normal link';}else{var message=result[0];if(result[1]!=''){output.style.color=getContrast(result[1]);}}
output.innerHTML=message;output.style.background=result[1];}})}else{var message='<div class="dvcn-link"></div>Normal link';output.innerHTML=message;output.style.background='';output.style.color='';}}
function openCloseCollapse(event){var ct=event.currentTarget;var container=ct.parentElement.parentElement;if(container.classList.contains('active')){container.classList.remove('active');}else{container.classList.add('active');}}
function deleteMode(event){var ct=event.currentTarget;var closest=ct.parentElement.parentElement.parentElement.parentElement.querySelector('.text_editor .add_text_layout');if(ct.classList.contains('active')){ct.classList.remove('active');closest.classList.remove('delete');}else{ct.classList.add('active');closest.classList.add('delete');}}
function checkLayoutPos(event){var ct=event.currentTarget;var layout=ct.querySelector('.add_text_layout');var layoutBox=layout.getBoundingClientRect();var actionBar=ct.querySelector('.action_bar');var adds=actionBar.querySelector('.adds');if(layoutBox.top<window.innerHeight-110||ct.offsetHeight>=ct.scrollHeight){if(!actionBar.classList.contains('active'))actionBar.classList.add('active');}else{if(actionBar.classList.contains('active')){actionBar.classList.remove('active');adds.classList.remove('active');}}}