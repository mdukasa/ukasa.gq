function getTzOffset(){var d=new Date();return d.getTimezoneOffset();}
function twoDigit(num){return('0'+(num)).slice(-2);}
function convertDate(date){var tzOffset=getTzOffset();date.setMinutes(date.getMinutes()+tzOffset);if(tzOffset>0){date.setDate(date.getDate()+1);}
mo=twoDigit(date.getMonth()+1),d=twoDigit(date.getDate()),y=date.getFullYear(),h=twoDigit(date.getHours()),mi=twoDigit(date.getMinutes()),s=twoDigit(date.getSeconds());var newDate=`${y}-${mo}-${d} ${h}:${mi}:${s}`;return newDate;}
function getAnalytics(msg){var button=document.querySelector('.extra[name="submit_dates"]');button.classList.add('loading');var start=document.querySelector('input[name="analytics_start_date"]').value;var end=document.querySelector('input[name="analytics_end_date"]').value;if(!end){end=start;}
var startDate=new Date(start);var endDate=new Date(end);var start=startDate;if(endDate<startDate){sendAlert('Please make sure the end date comes after the start date','Ok','yep');return;}
startDate.setHours(0,0,0,0);endDate.setHours(23,0,0,0);var tzOffset=getTzOffset();var finalStartDate=convertDate(startDate);var finalEndDate=convertDate(endDate);var formData=new FormData;formData.append('timestart',finalStartDate);formData.append('timeend',finalEndDate);var id=document.querySelector('.con_main_info').getAttribute('data-id');formData.append('id',id);$.ajax({type:"POST",url:"includes/getanalytics.inc.php",data:formData,contentType:false,processData:false,success:function(result){start.setMinutes(start.getMinutes()-tzOffset);if(result){drawChart(result,start);}}})}
function drawChart(result,start){var data=JSON.parse(result);let canvas=document.querySelector('canvas.graph');var dpi=window.devicePixelRatio;var width=document.querySelector('.rounded_panel.con_main_info').offsetWidth*dpi;canvas.width=width;canvas.height=200*dpi;let ctx=canvas.getContext('2d');ctx.beginPath();ctx.strokeStyle='white';ctx.lineWidth=3*dpi;ctx.lineCap="round";ctx.lineJoin="round";var length=Object.keys(data).length;var lengthHr=length*24;if(length==1){var span='hour';var spanAmount=24;var spanWidth=(width/spanAmount)/dpi;}else if(length<8){var span='day';var spanAmount=length;var spanWidth=(width/spanAmount)/dpi;}else if(length<64){var span='week';var spanAmount=length/7;var spanWidth=(width*(1/spanAmount))/dpi;}
if(span){xPlot=width/((lengthHr)*2),maxHeight=1,finalizeDate=[],graphEls=document.querySelector('.graph_els');graphEls.innerHTML='';for(var day in data){for(var hour in data[day]){var total=parseInt(data[day][hour].t);var unique=parseInt(data[day][hour].u);if(total>maxHeight){maxHeight=total;}
finalizeDate.push(total);if(span=='hour'){var spanEl=document.createElement('div');spanEl.addEventListener('mouseover',displayData,false);spanEl.classList.add('graph_el');spanEl.setAttribute('data-total',total);spanEl.setAttribute('data-unique',unique);spanEl.setAttribute('data-date',unique);var timeString=start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});var timeStringNext=new Date(start);timeStringNext.setMinutes(timeStringNext.getMinutes()+59);timeStringNext.setSeconds(timeStringNext.getSeconds()+59);timeStringNext=timeStringNext.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});timeString=`${timeString} - ${timeStringNext}`;spanEl.setAttribute('data-date',timeString);start.setHours(start.getHours()+1);graphEls.appendChild(spanEl);spanEl.style.width=`${spanWidth}px`;}}}
for(i=0;i<finalizeDate.length;i++){var adjustedHeight=(finalizeDate[i]/maxHeight)*180*dpi;if(i==0){ctx.moveTo(xPlot,(190*dpi)-adjustedHeight);}else{ctx.lineTo(xPlot,(190*dpi)-adjustedHeight);}
xPlot+=(width/lengthHr);}
ctx.stroke();if(span=='day'||span=='week'){tempFinalizeDate=[];var dayTotal=0;var toD=0;for(var i=0;i<finalizeDate.length;i++){dayTotal=dayTotal+finalizeDate[i];if(toD==23){if(span=='week'){tempFinalizeDate.push(dayTotal);}else if(span=='day'){var spanEl=document.createElement('div');spanEl.addEventListener('mouseover',displayData,false);spanEl.classList.add('graph_el');spanEl.setAttribute('data-total',dayTotal);timeString=`${start.toLocaleString([],{month:'long'})} ${start.getDate()}, ${start.getYear()+1900}`;spanEl.setAttribute('data-date',timeString);var inputStart=getISOString(start);spanEl.setAttribute('input-start',inputStart);start.setDate(start.getDate()+1);graphEls.appendChild(spanEl);spanEl.style.width=`${spanWidth}px`;}
toD=0;dayTotal=0;}else{toD++;}}
finalizeDate=tempFinalizeDate;if(span=='week'){tempFinalizeDate=[];var weekTotal=0;var doW=0;for(var i=0;i<finalizeDate.length;i++){weekTotal=weekTotal+finalizeDate[i];if(doW==6||i==(finalizeDate.length-1)){tempFinalizeDate.push(['',weekTotal]);var spanEl=document.createElement('div');spanEl.addEventListener('mouseover',displayData,false);spanEl.classList.add('graph_el');spanEl.setAttribute('data-total',weekTotal);var timeStringNext=new Date(start);timeStringNext.setDate(timeStringNext.getDate()+doW);timeString=`${start.toLocaleString([],{month:'long'})} ${start.getDate()}, ${start.getYear()+1900} - ${timeStringNext.toLocaleString([],{month:'long'})} ${timeStringNext.getDate()}, ${timeStringNext.getYear()+1900}`;spanEl.setAttribute('data-date',timeString);var inputStart=getISOString(start);var inputEnd=getISOString(timeStringNext);spanEl.setAttribute('input-start',inputStart);spanEl.setAttribute('input-end',inputEnd);start.setDate(start.getDate()+(doW+1));graphEls.appendChild(spanEl);if(doW==6){spanEl.style.width=`${spanWidth}px`;}else{var lastWidth=(spanAmount-Math.floor(spanAmount))*spanWidth;spanEl.style.width=`${lastWidth}px`;}
doW=0;weekTotal=0;}else{doW++;}}
finalizeDate=tempFinalizeDate;}}}
var button=document.querySelector('.extra[name="submit_dates"]');button.classList.remove('loading');}
function displayData(event){var ct=event.currentTarget;var display=document.querySelector('.graph_display');var total=parseInt(ct.getAttribute('data-total')).toLocaleString();var unique=ct.getAttribute('data-unique');display.innerHTML=`
	<h3 class='date_heading'><div class='dvcn-time'></div>${ct.getAttribute('data-date')}</h3>
	<h1>${total} clicks</h1>`;if(unique){var unique=parseInt(unique).toLocaleString();var uniqueText=document.createElement('h3');uniqueText.classList.add('unique_msg');var ending='people';if(unique==1){ending='person';}
uniqueText.innerHTML=`<div class='dvcn-uniqueuser'></div>${unique} unique ${ending}`;display.appendChild(uniqueText);}else{var expandButton=document.createElement('div');expandButton.classList.add('extra','button','expand_button');expandButton.innerHTML=`<h3><div class='dvcn-timeline'></div>Expand this timeline</h3>`;expandButton.addEventListener('click',expandTimeline,false)
display.insertBefore(expandButton,display.querySelector('h1'));}
var all=ct.parentElement.querySelectorAll('.graph_el');for(var i=0;i<all.length;i++){all[i].classList.remove('active');}
ct.classList.add('active');}
function updateDateSelector(event){var ct=event.currentTarget;var display=ct.parentElement.querySelector('.display');var val=ct.value;var tzOffset=getTzOffset();if(val){var date=new Date(val);date.setMinutes(date.getMinutes()+tzOffset);display.innerHTML=formatDate(date);}else{if(ct.getAttribute('name')=='analytics_start_date'){display.innerHTML='Select start date';}else{display.innerHTML='Add end date';}}}
function getISOString(time){var newTime=new Date(time);var tzOffset=getTzOffset();if(tzOffset<0){newTime.setDate(newTime.getDate()+1);}
var timeString=newTime.toISOString().slice(0,10);newTime=null;return timeString;}
function formatDate(date){var newDate=new Date(date);return `${newDate.toLocaleString([],{month:'long'})} ${newDate.getDate()}, ${newDate.getYear()+1900}`;}
function expandTimeline(){var el=document.querySelector('.graph_el.active');var startInput=document.querySelector('[name="analytics_start_date"]');startInput.value=el.getAttribute('input-start');var startDate=el.getAttribute('input-start');var startDateTime=new Date(startDate);var tzOffset=getTzOffset();startDateTime.setMinutes(startDateTime.getMinutes()+tzOffset);startInput.parentElement.querySelector('.display').innerHTML=formatDate(startDateTime);var endDate=el.getAttribute('input-end');var endInput=document.querySelector('[name="analytics_end_date"]');if(endDate){endInput.value=endDate;var endDateTime=new Date(endDate);endDateTime.setMinutes(endDateTime.getMinutes()+tzOffset);endInput.parentElement.querySelector('.display').innerHTML=formatDate(endDateTime);}else{endInput.value='';endInput.parentElement.querySelector('.display').innerHTML='Add end date';}
getAnalytics();}